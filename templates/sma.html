<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="description" content="" />
        <meta name="author" content="" />
        <title>Moving Average/ Stock Analysis</title>
        <link href="https://cdn.jsdelivr.net/npm/simple-datatables@7.1.2/dist/style.min.css" rel="stylesheet" />
        <link href="static/style.css" rel="stylesheet" />
        <script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js" crossorigin="anonymous"></script>
        <style>
        .error {
            color: red;
            font-size: 0.9em;
            margin-left: 5px;
        }
        </style>
        <script>
        function checkValidation() {
            let valid = true;

            document.getElementById("start_error").textContent = "";
            document.getElementById("end_error").textContent = "";
            document.getElementById("window_error").textContent = "";

            const startInput = document.getElementById("start_date");
            const endInput = document.getElementById("end_date");
            const windowInput = document.getElementById("days_window");

            const startVal = startInput.value;
            const endVal = endInput.value;
            const windowVal = windowInput.value;

            const start = new Date(startVal);
            const end = new Date(endVal);
            const daysWindow = parseInt(windowVal);

            if (startVal && isNaN(start.getTime())) {
                document.getElementById("start_error").textContent = "Please select a valid start date.";
                valid = false;
            }

            if (endVal && isNaN(end.getTime())) {
                document.getElementById("end_error").textContent = "Please select a valid end date.";
                valid = false;
            }

            if (startVal && endVal && !isNaN(start.getTime()) && !isNaN(end.getTime()) && start > end) {
                document.getElementById("end_error").textContent = "End date must be after start date.";
                valid = false;
            }

            if (windowVal && (daysWindow < 1 || isNaN(daysWindow))) {
                document.getElementById("window_error").textContent = "Window must be at least 1.";
                valid = false;
            } else if (startVal && endVal && !isNaN(start.getTime()) && !isNaN(end.getTime()) && daysWindow > Math.ceil((end - start) / (1000*60*60*24)+1)) {
                const diffDays = Math.ceil((end - start) / (1000*60*60*24)) + 1;
                document.getElementById("window_error").textContent =
                    "Window cannot exceed total days in range (" + diffDays + ").";
                valid = false;
            }

            return valid;
        }

        function validateForm() {
            return checkValidation();
        }

        document.addEventListener("DOMContentLoaded", function() {
            const inputs = ["start_date", "end_date", "days_window"];
            inputs.forEach(id => {
                document.getElementById(id).addEventListener("input", checkValidation);
            });
        });
        </script>
    </head>
    <body class="sb-nav-fixed">
        <nav class="sb-topnav navbar navbar-expand navbar-dark bg-dark">
            <!-- Navbar Brand-->
            <a class="navbar-brand ps-3" href="/">Stock Analysis</a>
        </nav>
        <div id="layoutSidenav">
            <div id="layoutSidenav_nav">
                <nav class="sb-sidenav accordion sb-sidenav-dark" id="sidenavAccordion">
                    <div class="sb-sidenav-menu">
                        <div class="nav">
                            <div class="sb-sidenav-menu-heading">Core Functionalities</div>
                            <a class="nav-link" href="/">
                                Home
                            </a> 
                            <a class="nav-link" href="/sma">
                                Moving Average Calculator
                            </a>
                            <a class="nav-link" href="/daily_return">
                                Daily Returns Calculator
                            </a>
                            <a class="nav-link" href="/trend">
                                Trend Finder
                            </a>
                            <a class="nav-link" href="/max_profit">
                                Max Profit Finder
                            </a>
                            <a class="nav-link" href="/range">
                                Range Finder
                            </a>
                        </div>
                    </div>
                </nav>
            </div>
            <div id="layoutSidenav_content">
                <main>
                    <div class="container-fluid px-4">
                        <h1 class="mt-4">Moving Average Calculator</h1>
                        <div class="row">
                            <div class="col-xl-3">
                                <form method="POST" class="form-group" onsubmit="return validateForm()">
                                    <h3>Calculate Moving Averages</h3>
                                    <label for="source">Source:</label>
                                    <select class="form-select" list="source" name="source" placeholder="Select Stock Ticker" required>
                                        <option value="LOCAL">LOCAL</option>
                                        <option value="AAPL">AAPL</option>
                                        <option value="MSFT">MSFT</option>
                                        <option value="GOOG">GOOG</option>
                                        <option value="NVDA">NVDA</option>
                                        <option value="AMZN">AMZN</option>
                                        <option value="TSLA">TSLA</option>
                                        <option value="META">META</option>
                                    </select>
                                    <br>
                                    <label for="start_date">Start Date:</label>
                                    <input type="date" id="start_date" name="start_date" required>
                                    <span class="error" id="start_error"></span>
                                    <br>
                                    <label for="end_date">End Date:</label>
                                    <input type="date" id="end_date" name="end_date" required>
                                    <span class="error" id="end_error"></span>
                                    <br>
                                    <label for="days_window">SMA and EMA Window (days):</label>
                                    <input type="number" id="days_window" name="days_window" min="1" placeholder="1" required>
                                    <span class="error" id="window_error"></span>
                                    <br>
                                    <button type="submit">Calculate</button>
                                </form>
                            </div>
                            <div class="col-xl-8">
                                 {% if maGraph %}
                                    {{ maGraph | safe }}
                                {% endif %}

                                {% if results %}
                                    <h3>{{ source }} Results for {{ days_window }}-Day SMA and EMA ({{ start_date.date() }} â†’ {{ end_date.date() }})</h3>
                                    <table class = "table table-striped">
                                        <tr>
                                            <th>Date</th>
                                            <th>Close</th>
                                            <th>SMA</th>
                                            <th>EMA</th>
                                        </tr>

                                    {% for i in results %}
                                        <tr>
                                            <td>{{ i["Date"].strftime("%Y-%m-%d") }}</td>
                                            <td>${{ "%.2f"|format(i["Close/Last"]) }}</td>
                                            <td>
                                                {% if i["SMA"] %}
                                                    ${{ "%.2f"|format(i["SMA"]) }}
                                                {% else %}
                                                    -
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if i["EMA"] %}
                                                    ${{ "%.2f"|format(i["EMA"]) }}
                                                {% else %}
                                                    -
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endfor %}

                                    </table>
                                    
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    </div>
                </main>
            </div>
        </div>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
        <script src="js/scripts.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.min.js" crossorigin="anonymous"></script>
        <script src="assets/demo/chart-area-demo.js"></script>
        <script src="assets/demo/chart-bar-demo.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/simple-datatables@7.1.2/dist/umd/simple-datatables.min.js" crossorigin="anonymous"></script>
        <script src="js/datatables-simple-demo.js"></script>
    </body>
</html>
